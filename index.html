<!DOCTYPE html>
<html lang="pt-BR">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Stemma Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body{
  background:#000;
  color:#fff;
  font-family: system-ui, sans-serif;
}

.stemma-green{
  color:#39B54A;
}
</style>

</head>

<body>

<div class="max-w-[1800px] mx-auto p-4">

<!-- HEADER -->

<header class="mb-6 flex items-center gap-3">

<h1 class="text-xl font-bold stemma-green">
  Stemma Dashboard
</h1>

</header>


<!-- GRID -->

<section class="border border-gray-700 rounded">

<div class="px-4 py-2 border-b border-gray-700 stemma-green font-semibold text-sm">
  Stemma Programs
</div>

<div
  id="programGrid"
  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 p-3">
</div>

</section>

</div>


<script>

/* ================= CONFIG ================= */

const API_KEY = 'AIzaSyD8S6q4rRO_e-A2uk2lAfD2_L0JV2JfQm8';
const CHANNEL_ID = 'UCbIIzoBpRfVXA4YFRVA3osQ';

const PROGRAMS = [
  'Stemma Podcast',
  'Stemma Performance',
  'Radar Stemma',
  'Girls Who Run',
  'Caf√© com Tri',
  'Na Roda do Stemma',
  'Nata√ß√£o Stemma',
  'Especiais'
];

const RULES = {
  'Stemma Podcast': ['podcast'],
  'Stemma Performance': ['performance'],
  'Radar Stemma': ['radar'],
  'Girls Who Run': ['girls'],
  'Caf√© com Tri': ['tri','cafe'],
  'Na Roda do Stemma': ['roda'],
  'Nata√ß√£o Stemma': ['nata']
};

const CACHE_KEY = 'stemma_cache_v10';
const CACHE_TTL = 24*60*60*1000;


/* ================= STATS ================= */

const STATS = {
  private:0,
  deleted:0,
  ignored:0
};


/* ================= EP DETECTOR ================= */

function extractEpisodeNumber(title){

  const t = title.toLowerCase();

  const patterns = [

    /\b(e|ep)\s*\.?\s*(\d{1,4})\b/i,
    /#\s*(\d{1,4})/,
    /^\s*(\d{1,4})\s*[-:|.]/,
    /^\s*(\d{1,4})\s+/,
    /[\s|]\s*(\d{1,4})\s*[\s|]/

  ];

  for(const p of patterns){

    const m = t.match(p);

    if(m){

      const n = m[2] || m[1];
      const num = parseInt(n,10);

      if(num>0 && num<5000) return num;
    }
  }

  return null;
}


/* ================= CACHE ================= */

function getCache(){

  try{

    const raw = localStorage.getItem(CACHE_KEY);

    if(!raw) return null;

    const obj = JSON.parse(raw);

    if(Date.now()-obj.time > CACHE_TTL){

      localStorage.removeItem(CACHE_KEY);
      return null;
    }

    return obj.data;

  }catch{
    return null;
  }
}


function setCache(data){

  try{

    localStorage.setItem(
      CACHE_KEY,
      JSON.stringify({time:Date.now(),data})
    );

  }catch{}
}


/* ================= FETCH ================= */

async function fetchJSON(url){

  try{

    const r = await fetch(url);

    if(!r.ok) return null;

    return await r.json();

  }catch{
    return null;
  }
}


/* ================= YOUTUBE ================= */

async function getPlaylists(){

  let all=[],token=null;

  do{

    const url=new URL(
      'https://www.googleapis.com/youtube/v3/playlists'
    );

    url.search=new URLSearchParams({
      part:'snippet',
      channelId:CHANNEL_ID,
      maxResults:50,
      key:API_KEY,
      ...(token?{pageToken:token}:{})
    });

    const data=await fetchJSON(url);

    if(!data?.items) break;

    all=all.concat(data.items);

    token=data.nextPageToken;

  }while(token);

  return all;
}


async function getVideos(pid){

  let all=[],token=null;

  do{

    const url=new URL(
      'https://www.googleapis.com/youtube/v3/playlistItems'
    );

    url.search=new URLSearchParams({
      part:'snippet',
      playlistId:pid,
      maxResults:50,
      key:API_KEY,
      ...(token?{pageToken:token}:{})
    });

    const data=await fetchJSON(url);

    if(!data?.items) break;

    all=all.concat(data.items);

    token=data.nextPageToken;

  }while(token);

  return all;
}


/* ================= RESOLVE ================= */

function resolveByPlaylist(title){

  const t=title.toLowerCase();

  for(const p in RULES){

    for(const k of RULES[p]){

      if(t.includes(k)) return p;
    }
  }

  return null;
}


function resolveByTitle(title){

  const t=title.toLowerCase();

  if(t.includes('podcast')) return 'Stemma Podcast';
  if(t.includes('performance')) return 'Stemma Performance';
  if(t.includes('radar')) return 'Radar Stemma';
  if(t.includes('girls')) return 'Girls Who Run';
  if(t.includes('tri')) return 'Caf√© com Tri';
  if(t.includes('roda')) return 'Na Roda do Stemma';
  if(t.includes('nata')) return 'Nata√ß√£o Stemma';

  return null;
}


/* ================= MAIN ================= */

async function loadPrograms(){

  const cached=getCache();

  if(cached){
    render(cached);
    report();
    return;
  }


  const playlists=await getPlaylists();

  const map={};

  PROGRAMS.forEach(p=>map[p]=[]);


  for(const pl of playlists){

    if(!pl.snippet?.title) continue;

    const base=resolveByPlaylist(pl.snippet.title);

    const vids=await getVideos(pl.id);


    for(const v of vids){

      if(!v.snippet) continue;


      /* REMOVE PRIVATE / DELETED */

      if(
        !v.snippet.resourceId?.videoId ||
        v.snippet.title === 'Private video' ||
        v.snippet.title === 'Deleted video' ||
        v.snippet.title === 'Apagar'
      ){
        STATS.private++;
        continue;
      }


      const title = v.snippet.title;

      const ep = extractEpisodeNumber(title);

      let program = null;


      /* SEM N√öMERO ‚Üí ESPECIAIS */

      if(ep === null){

        program = 'Especiais';
      }

      /* COM N√öMERO ‚Üí PROGRAMA */

      else{

        if(base){
          program = base;
        }
        else{
          program = resolveByTitle(title);
        }

        if(!program){
          STATS.ignored++;
          continue;
        }
      }


      map[program].push(v.snippet);
    }
  }


  Object.values(map).forEach(list=>{
    list.sort((a,b)=>
      new Date(b.publishedAt)-new Date(a.publishedAt)
    );
  });


  setCache(map);

  render(map);

  report();
}


/* ================= REPORT ================= */

function report(){

  console.group('üìä Relat√≥rio Stemma');

  console.log('Privados/Deletados:',STATS.private);
  console.log('Ignorados:',STATS.ignored);

  console.groupEnd();
}


/* ================= RENDER ================= */

function render(map){

  const grid=document.getElementById('programGrid');

  grid.innerHTML='';


  PROGRAMS.forEach(name=>{

    const list=map[name]||[];

    const main=list[0];

    const past=list.slice(1,6);


    grid.insertAdjacentHTML('beforeend',`

      <div class="border border-gray-700 rounded p-2">

        <div class="text-xs stemma-green font-semibold mb-1">
          ${name}
        </div>

        ${
          main
            ? mainCard(main)
            : '<div class="text-xs text-gray-500">Sem v√≠deos</div>'
        }

        <div class="border-t border-gray-700 mt-1 pt-1 space-y-1">
          ${past.map(miniCard).join('')}
        </div>

      </div>
    `);
  });
}


function mainCard(v){

  const id=v.resourceId.videoId;

  const t=
    v.thumbnails?.medium?.url||
    v.thumbnails?.default?.url||
    '';

  return`

    <a href="https://youtube.com/watch?v=${id}" target="_blank">

      <img src="${t}" class="w-full rounded mb-1">

      <div class="text-xs font-medium line-clamp-2">
        ${v.title}
      </div>

      <div class="text-[10px] text-gray-400">
        ${new Date(v.publishedAt).toLocaleDateString()}
      </div>

    </a>
  `;
}


function miniCard(v){

  const id=v.resourceId.videoId;

  return`

    <a href="https://youtube.com/watch?v=${id}"
       target="_blank"
       class="block text-[10px] text-gray-300 hover:text-[#39B54A] truncate">

      ‚ñ∂ ${v.title}

    </a>
  `;
}


/* ================= INIT ================= */

window.onload=()=>{

  if(API_KEY==='SUA_API_KEY_AQUI'){
    alert('Coloque sua API Key do YouTube');
    return;
  }

  localStorage.clear();

  loadPrograms();
};

</script>

</body>
</html>
